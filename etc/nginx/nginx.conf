# garfield

user www-data;

worker_processes auto;
worker_cpu_affinity auto;
worker_rlimit_nofile 65535;

quic_bpf on;

pid /run/nginx.pid;

error_log /var/log/nginx/error.log warn;

include /etc/nginx/modules-enabled/*.conf;

events {
	worker_connections 32768;
	multi_accept on;
	use epoll;
}

http {

	##
	# Basic Settings
	##

	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	aio threads;
	server_tokens off;
	types_hash_max_size 4096;
	server_names_hash_bucket_size 128;

	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	##
	# Replace "Server" and "X-Powered-By" Headers
	##

	split_clients "${request_id}" $server_cat {
		10%       "Apache/1.3.37";                 # EOL 2010, no patches for 15+ years
		10%       "Microsoft-IIS/6.0";             # CVE-2017-7269 RCE, WebDAV exploits
		10%       "Zeus/4.2";                      # CVE-2010-0359 SSLv2 buffer overflow, EOL 2011
		10%       "nginx/0.7.65";                  # Pre-1.0, buffer overflow CVEs
		10%       "Apache-Coyote/1.1";             # Ancient Tomcat, Log4j vibes
		10%       "lighttpd/1.4.18";               # CVE-2011-4362 DoS, 2007 vintage
		10%       "IBM_HTTP_Server/6.0";           # EOL 2018, enterprise nightmare
		10%       "Oracle-Application-Server/10g"; # EOL 2011, Oracle's ghost
		10%       "Sun-ONE-Web-Server/6.1";        # EOL 2009, Sun Microsystems relic
		*         "Tomcat/5.5.23";                 # Default creds, CVE-2007-3385+
	}

	more_set_headers "Server: $server_cat";

	split_clients "${request_id}" $powered_cat {
		25%       "PHP/4.4.9";        # EOL 2008, register_globals era
		25%       "ASP.NET/1.1.4322"; # .NET Framework 1.1, EOL 2009
		25%       "JSP/2.0";          # Signals ancient Java
		*         "Servlet/2.4";      # Tomcat 5.x era
	}

	more_set_headers "X-Powered-By: $powered_cat";

	##
	# Timeouts
	##

	client_body_timeout 10s;
	client_header_timeout 10s;
	keepalive_timeout 60s;
	send_timeout 20s;
	  reset_timedout_connection on;

	##
	# Buffer & Size limits
	##

	client_body_buffer_size 128k;
	client_header_buffer_size 1k;
	client_max_body_size 20m;
	large_client_header_buffers 4 8k;
	ignore_invalid_headers on;
	output_buffers 2 1m;

	##
	# SSL Settings
	##

	ssl_protocols TLSv1.3 TLSv1.2;
	ssl_session_cache shared:SSL:10m;
	ssl_session_timeout 1d;
	ssl_session_tickets off;
	ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256;
	ssl_conf_command Options PrioritizeChaCha;
	ssl_ecdh_curve X25519MLKEM768:X25519:prime256v1;

	# TLSv1.2 support
	ssl_prefer_server_ciphers on;
	ssl_ciphers "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256";

	##
	# QUIC / HTTP/3
	##
	ssl_early_data off;
	quic_retry on;
	quic_gso on;

	more_set_headers "Alt-Svc: h3=\":443\"; ma=86400";

	##
	# Security Headers
	##
	more_set_headers "X-Frame-Options: SAMEORIGIN";
	more_set_headers "X-Content-Type-Options: nosniff";
	more_set_headers "Referrer-Policy: strict-origin";
	more_set_headers "Reporting-Endpoints: csp=\"https://sec.shrt.day/meow\"";
	more_set_headers "Content-Security-Policy: default-src 'self'; img-src https: data: blob:; media-src https: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://scout.shrt.day; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://scout.shrt.day; base-uri 'self'; form-action 'self'; report-to csp; report-uri https://sec.shrt.day/meow;";

	# we do not do http around here
	more_set_headers "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload";

	##
	# Cache Settings
	##

	open_file_cache max=100000 inactive=20s;
	open_file_cache_valid 30s;
	open_file_cache_min_uses 2;
	open_file_cache_errors on;

	##
	# Logging Settings
	##

	access_log /var/log/nginx/access.log;

	##
	# Gzip Settings
	##

	gzip on;
	gzip_vary on;
	gzip_comp_level 6;
	gzip_min_length 256;
	gzip_proxied any;
	gzip_static on;
	gzip_types
		text/plain text/css text/xml application/xml application/xhtml+xml
		application/rss+xml application/javascript application/json
		image/svg+xml application/x-font-ttf font/ttf font/otf
		application/vnd.ms-fontobject font/woff font/woff2;

	##
	# Brotli Settings
	##

	brotli on;
	brotli_comp_level 4;
	brotli_types text/plain text/css application/javascript application/json image/svg+xml;
	brotli_min_length 256;
	brotli_static on;

	##
	# Proxy Defaults
	##

	proxy_http_version 1.1;
	proxy_set_header Host $host;

	proxy_set_header X-Real-IP $remote_addr;
	proxy_set_header X-Forwarded-For $remote_addr;
	proxy_set_header X-Forwarded-Proto $scheme;

	proxy_cache_bypass $http_upgrade;

	map $http_upgrade $connection_upgrade {
		default upgrade;
		""      close;
	}

	proxy_set_header Connection $connection_upgrade;
	proxy_set_header Upgrade $http_upgrade;
	proxy_set_header Forwarded "";

	##
	# Custom blocker list
	##

	include wall.conf;

	##
	# Virtual Host Configs
	##

	server {
		listen 443 ssl;
		listen 443 quic;
		server_name example.com;
		http2 on;

		if ($block_request) {
			return 444;
		}

		root /var/example.com;

		location / {
			index index.html index.htm;
		}

		ssl_certificate /var/.ssl/example.com/cert.pem;
		ssl_certificate_key /var/.ssl/example.com/key.pem;
	}

	# default catch-all

	server {
		listen 80 default_server;
		listen [::]:80 default_server;

		server_name _;

		return 444;
	}

	server {
		listen 443 ssl default_server;
		listen [::]:443 ssl default_server;

		server_name _;

		ssl_reject_handshake on;

		return 444;
	}
}
